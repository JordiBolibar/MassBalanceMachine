# Data (Pre)Processing

The following scripts are the bare minimum for the data (pre)processing stage of the MassBalanceMachine. Topographical and climatological features are added to the dataset for each stake measurement. The scripts in this folder should be run in the following order: 

1. ```get_oggm_data.py``` The script in the ```oggm``` folder, located outside the current working directory, retrieves topographical features for all stakes on the glaciers. These features include slope, aspect, slope factor, and distance from the border. Please consult [OGGM](https://docs.oggm.org/en/stable/) for more information on the topographical features. The script takes the file ```region_stake_data.csv``` as input and outputs ```region_stake_data_topo_attributes.csv```. 
   - **Note**: This script is stored in a separate folder because it requires a remote environment, WSL, to run for Windows machines. In the future, the aim is to implement this as a separate step in the data pipeline without the need to do it manually, e.g., start the remote process and activate the Conda environment. Please read the README in the ```oggm``` folder for more details on the installation process.
   - **Important**: To run this script, every record in the dataset should already contain an RGI ID. If this ID is unavailable, the topographical features cannot be fetched from OGGM. Please see the script ```match_rgiids_with_stakes.py``` in the folder: ```regions/iceland``` how RGI IDs can be retrieved and matched with the stake measurements. 
   - ```region_stake_data.csv``` is your initial stake measurement dataset containing, for example, the following columns: latitude, longitude, surface mass balances, measuring dates, hydrological year, RGI ID, etc.
2. ```get_climate_data.py``` For each stake measurement, monthly averaged climate data from the Copernicus Climate Data Store from 1950 to 2024 can be retrieved from [here](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-land-monthly-means?tab=overview). And the geopotential surface pressure can be retrieved from [here](https://confluence.ecmwf.int/display/CKB/ERA5-Land%3A+data+documentation#ERA5Land:datadocumentation-parameterlistingParameterlistings) (netCDF4). The script takes the file ```region_stake_data_topo_attributes.csv``` as input and outputs ```region_stake_data_climate.csv```.
   1. **Note**: Fetching from the CDS API can take up to several hours, depending on the time scale and the number of variables of interest. 
3. ```transform_data_to_wgms.py``` Transforms and refactors the data to the WGMS format in case the data is ever uploaded to the WGMS database. The script takes the file ```region_stake_data_climate.csv``` as input and outputs ```region_stake_data_wgms.csv```.

```region_stake_data_climate.csv``` can be used as a training dataset for the machine learning model. Additionally, one can add more scripts for further (pre)processing, such as further data cleaning, removing NaN values, reprojecting coordinates, and feature engineering. Inspiration can be taken from the regions in the regions directory in this repository. 
